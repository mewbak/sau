//Credits go to people at Enlight Software, who relesaed the game's source code

#include "common.h"


static u1 Pal[] = { //extracted from pal_std.res
 0x00, 0x00, 0x00, 0x00, 0x00, 0x2B, 0x00, 0x13,
 0x3F, 0x00, 0x37, 0x53, 0x00, 0x67, 0x63, 0x00,
 0x7B, 0x4B, 0x00, 0x8F, 0x47, 0x00, 0xA7, 0x43,
 0x00, 0xBB, 0x37, 0x00, 0xD3, 0x27, 0x00, 0xE7,
 0x17, 0x14, 0xFF, 0x00, 0x57, 0xFF, 0x2F, 0x9B,
 0xFF, 0x5F, 0xCF, 0xFF, 0x8F, 0xD3, 0xFF, 0xBF,
 0xF3, 0xFF, 0xF3, 0x00, 0x23, 0x27, 0x00, 0x00,
 0xFF, 0x00, 0x9F, 0xFF, 0x00, 0x7F, 0xCF, 0x00,
 0x2F, 0x33, 0x00, 0x3F, 0x43, 0x00, 0x4F, 0x4F,
 0x00, 0x5F, 0x5F, 0x00, 0x6F, 0x6B, 0x00, 0x83,
 0x7B, 0x00, 0x97, 0x87, 0x00, 0xAB, 0x93, 0x2B,
 0xBF, 0x93, 0x5F, 0xD3, 0x9F, 0x9F, 0xE7, 0xBB,
 0x0B, 0x1B, 0x0B, 0x0F, 0x27, 0x0F, 0x13, 0x33,
 0x13, 0x1B, 0x43, 0x1B, 0x27, 0x4F, 0x1F, 0x37,
 0x5F, 0x27, 0x4B, 0x6B, 0x2B, 0x63, 0x7B, 0x2F,
 0x7F, 0x8B, 0x37, 0x8B, 0x9F, 0x4F, 0x9B, 0xB7,
 0x6F, 0xAF, 0xCF, 0x93, 0xCB, 0xE7, 0xBB, 0x00,
 0x00, 0x57, 0x07, 0x0F, 0x67, 0x17, 0x27, 0x7B,
 0x27, 0x3F, 0x8F, 0x3F, 0x5F, 0x9F, 0x57, 0x7B,
 0xB3, 0x73, 0x9B, 0xC7, 0x93, 0xBB, 0xD7, 0xBB,
 0xD7, 0xEB, 0xE3, 0xF7, 0xFF, 0x5B, 0x5B, 0x00,
 0x77, 0x77, 0x00, 0x93, 0x93, 0x00, 0xAB, 0xAB,
 0x00, 0xC7, 0xC7, 0x00, 0xE3, 0xE3, 0x00, 0xFE,
 0xFE, 0x00, 0xFF, 0xFF, 0x27, 0xFF, 0xFF, 0x4F,
 0x00, 0x00, 0x1F, 0x07, 0x07, 0x2F, 0x0F, 0x0F,
 0x3F, 0x1F, 0x1F, 0x53, 0x33, 0x33, 0x63, 0x4B,
 0x4B, 0x77, 0x57, 0x57, 0x87, 0x63, 0x67, 0x97,
 0x73, 0x77, 0xA7, 0x7F, 0x83, 0xB7, 0x8F, 0x97,
 0xCB, 0x9F, 0xA7, 0xD3, 0xB3, 0xB7, 0xDF, 0xC7,
 0xC7, 0xE7, 0xDB, 0xDB, 0xF3, 0xF3, 0xF3, 0xFF,
 0x53, 0x3B, 0x27, 0x57, 0x3B, 0x2B, 0x5B, 0x3F,
 0x2F, 0x5F, 0x43, 0x37, 0x63, 0x47, 0x3B, 0x67,
 0x4B, 0x3F, 0x6B, 0x4F, 0x47, 0x6F, 0x57, 0x4F,
 0x7F, 0x67, 0x5F, 0x93, 0x7B, 0x6F, 0xA3, 0x8F,
 0x83, 0xB7, 0xA3, 0x97, 0xC7, 0xB7, 0xAF, 0xDB,
 0xCF, 0xC3, 0xEB, 0xE3, 0xDB, 0xFF, 0xFB, 0xF7,
 0x33, 0x7E, 0x76, 0x15, 0x6C, 0x5E, 0x4A, 0x44,
 0x2A, 0x53, 0x4C, 0x30, 0x5C, 0x54, 0x35, 0x65,
 0x5C, 0x3B, 0x6E, 0x64, 0x40, 0x77, 0x6C, 0x46,
 0x80, 0x74, 0x4B, 0x8A, 0x7E, 0x56, 0x93, 0x88,
 0x61, 0x9D, 0x92, 0x6C, 0xA6, 0x9C, 0x77, 0xB0,
 0xA6, 0x82, 0xB9, 0xB0, 0x8D, 0xC3, 0xBA, 0x98,
 0x23, 0x23, 0x1F, 0x2F, 0x2F, 0x23, 0x3F, 0x37,
 0x23, 0x4E, 0x37, 0x23, 0x5F, 0x33, 0x1B, 0x73,
 0x47, 0x27, 0x8B, 0x5B, 0x37, 0xA3, 0x73, 0x4F,
 0xBB, 0x8F, 0x63, 0xD3, 0xAB, 0x7F, 0xD7, 0xB7,
 0x8F, 0xDF, 0xC3, 0x9F, 0xE7, 0xCF, 0xAF, 0xEF,
 0xDB, 0xC3, 0xF7, 0xEB, 0xD7, 0xFF, 0xF7, 0xEB,
 0xC4, 0xCD, 0x6A, 0xF3, 0xBA, 0x55, 0xE6, 0xA3,
 0x4A, 0xA7, 0x94, 0x5B, 0x9A, 0xAF, 0x53, 0x83,
 0x8F, 0x8B, 0x7B, 0x77, 0x9F, 0x88, 0x64, 0xA6,
 0x8C, 0x78, 0xB9, 0xA1, 0x75, 0xBA, 0xA3, 0x8B,
 0xD7, 0xAF, 0xAE, 0xC7, 0xC5, 0xB0, 0xA6, 0xCD,
 0xB4, 0xAC, 0xD2, 0xBF, 0xA8, 0xCA, 0xA6, 0x95,
 0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x20, 0x20,
 0x20, 0x30, 0x30, 0x30, 0x40, 0x40, 0x40, 0x50,
 0x50, 0x50, 0x60, 0x60, 0x60, 0x70, 0x70, 0x70,
 0x80, 0x80, 0x80, 0x8F, 0x8F, 0x8F, 0x9F, 0x9F,
 0x9F, 0xAF, 0xAF, 0xAF, 0xBF, 0xBF, 0xBF, 0xCF,
 0xCF, 0xCF, 0xDF, 0xDF, 0xDF, 0xEF, 0xEF, 0xEF,
 0xEB, 0x02, 0x02, 0xA9, 0x01, 0x01, 0x7C, 0x01,
 0x01, 0x50, 0x00, 0x00, 0x71, 0x71, 0xF1, 0x50,
 0x5B, 0xD5, 0x1E, 0x3A, 0xAC, 0x0E, 0x2F, 0x9E,
 0x42, 0xD1, 0x02, 0x2D, 0xAF, 0x1D, 0x18, 0x92,
 0x38, 0x04, 0x67, 0x43, 0xA6, 0x45, 0xA7, 0x88,
 0x2E, 0x8C, 0x5C, 0x0B, 0x63, 0x4D, 0x00, 0x55,
 0xF9, 0xB0, 0x2B, 0xD6, 0x80, 0x02, 0xB4, 0x60,
 0x01, 0x71, 0x20, 0x00, 0xFC, 0xFC, 0x48, 0xE4,
 0xCC, 0x28, 0xCC, 0xA0, 0x10, 0xB4, 0x74, 0x00,
 0x9E, 0x7E, 0x3F, 0x93, 0x6C, 0x2C, 0x74, 0x4D,
 0x1D, 0x50, 0x30, 0x0F, 0x88, 0x93, 0x90, 0x6A,
 0x73, 0x70, 0x62, 0x69, 0x67, 0x50, 0x59, 0x57,
 0xA4, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x5C, 0x04,
 0x00, 0x44, 0x04, 0x00, 0x0C, 0x48, 0xCC, 0x04,
 0x28, 0xA0, 0x00, 0x14, 0x74, 0x00, 0x04, 0x4C,
 0x4A, 0x87, 0x61, 0x15, 0x81, 0x59, 0x06, 0x6D,
 0x34, 0x00, 0x4D, 0x0C, 0x5B, 0x2D, 0x6A, 0x74,
 0x2C, 0x84, 0x50, 0x18, 0x58, 0x2C, 0x08, 0x2C,
 0xF8, 0x8C, 0x14, 0xC8, 0x60, 0x10, 0x98, 0x3C,
 0x10, 0x6C, 0x20, 0x0C, 0xDE, 0xDA, 0x0A, 0xB1,
 0xB2, 0x07, 0x6E, 0x75, 0x03, 0x58, 0x61, 0x02,
 0x86, 0x57, 0x57, 0x6C, 0x43, 0x43, 0x50, 0x2B,
 0x2B, 0x0E, 0x00, 0x00, 0x76, 0x83, 0x7F, 0x67,
 0x70, 0x6D, 0x4E, 0x55, 0x53, 0x3D, 0x44, 0x42,
 0x21, 0x21, 0x21, 0x6B, 0x52, 0x08, 0x8C, 0x63,
 0x08, 0x94, 0x73, 0x08, 0xB5, 0x84, 0x08, 0xBD,
 0x94, 0x08, 0xD6, 0x9C, 0x00, 0xD6, 0xB5, 0x08,
 0xEF, 0xC6, 0x10, 0xFF, 0xEF, 0x18, 0xFF, 0xF7,
 0x5A, 0xFF, 0xFF, 0x8C, 0x00, 0x00, 0x00, 0xFF,
 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0xFF,
 0x1A, 0x42, 0x77, 0x1B, 0x47, 0x83, 0x28, 0x4E,
 0x81, 0x37, 0x56, 0x80, 0x48, 0x63, 0x87, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};


// for transparent code repeated for 1 to UNIQUE_REPEAT_CODE_NUM times,
// write FEW_TRANSPARENT_CODE(repeated_times)
// for transparent code repeated for UNIQUE_REPEAT_CODE_NUM+1 to 255 times,
// write two bytes, MANY_TRANSPARENT_CODE and repeated_times

#define TRANSPARENT_CODE			255

// total no. of bytes used by transparent pixels and
// compressed transparent pixels is 7+1 (the last 1 is
// the first byte of the 2 bytes compression code)
#define UNIQUE_REPEAT_CODE_NUM	  7	

#define FEW_TRANSPARENT_CODE(n) (0xFF-n+1)
#define MANY_TRANSPARENT_CODE   0xf8
#define MIN_TRANSPARENT_CODE    0xf8
#define MAX_TRANSPARENT_CODE    0xff

#define SHADOW_CODE      		  0x00
#define OUTLINE_CODE            0xf2
#define OUTLINE_SHADOW_CODE     0xf3


//FIXME: implement colorTable remapping to player colors

void IMGbltTransRemapDecompress(char* imageBuf, int pitch, int desX, int desY, char* bitmapBuf, char* colorTable)
{
 int i,j;
	int destline = desY * pitch + desX;
	int width = ((unsigned char*)bitmapBuf)[0] + (((unsigned char*)bitmapBuf)[1]<<8);
	int height = ((unsigned char*)bitmapBuf)[2] + (((unsigned char*)bitmapBuf)[3]<<8);
	int esi = 4;		// 4 bytes of bitmap header (16bit width, 16bit height)
	int pixelsToSkip = 0;
	int al;

	for ( j=0; j<height; ++j,destline+=pitch )
	{
		for ( i=0; i<width; ++i )
		{
			if (pixelsToSkip != 0)
			{
				if (pixelsToSkip >= width-i)
				{
					// skip to next line
					pixelsToSkip -= width-i;
					break;
				}
				i += pixelsToSkip;
				pixelsToSkip = 0;
			}
			al = ((unsigned char*)bitmapBuf)[ esi++ ];		// load source byte
			al = al;//((unsigned char*)colorTable)[ al ];			// translate
			if (al < MIN_TRANSPARENT_CODE)
			{
				imageBuf[ destline + i ] = al;	// normal pixel
			}
			else if (al == MANY_TRANSPARENT_CODE)
			{
				pixelsToSkip = ((unsigned char*)bitmapBuf)[ esi++ ] -1;		// skip many pixels
			}
			else
			{
				pixelsToSkip = 256 - al -1;					// skip (neg al) pixels
			}
		}
	}
}

static void ssaaDecompile(char *Output, char *Input) {
  int I, J, K, X, Y, C;
  int FrameN;
  char Tmp[1024], Name[16];
  pic *P;
  int L = fileSize(Input);
  u1 *Q = readFile(0, L, Input);
  u1 *E = Q+L;

  FrameN = 0;

  while (Q < E) {
    int Sz = u4le(Q);
    Q+=4;

    P = picNew(u2le(Q), u2le(Q+2), 8);
    P->K = 0;
    times(I,256) {
      P->P[I*4+0] = Pal[I*3+0];
      P->P[I*4+1] = Pal[I*3+1];
      P->P[I*4+2] = Pal[I*3+2];
    }

    printf("  Frame%d: size=%d, Width=%d, Height=%d\n", FrameN, Sz, P->W, P->H);

    IMGbltTransRemapDecompress(P->D, P->W, 0, 0, Q, 0);

    sprintf(Tmp, "%s/%04d.png", Output, FrameN);
    pngSave(Tmp, P);

    FrameN++;
    Q += Sz;
  }
}

int ssaaInit(format *F) {
  F->Type = FMT_ARCHIVE;
  F->Name = "ssaa";
  F->Description = "Seven Kingdoms: Ancient Adversaries sprites (spr)";
  F->Decompile = ssaaDecompile;
  return 1;
}

