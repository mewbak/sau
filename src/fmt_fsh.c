#include "common.h"

static u1 Pal[] = {
 0x00, 0x00, 0x00, 0x00, 0xF7, 0x37, 0x00, 0xF7,
 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00,
 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37,
 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0xFF, 0x37,
 0x37, 0xE3, 0x27, 0x27, 0xC7, 0x17, 0x17, 0xAB,
 0x0B, 0x0B, 0x8F, 0x07, 0x07, 0x63, 0x00, 0x00,
 0xE7, 0xD3, 0xD7, 0xD3, 0xA3, 0xAF, 0xBF, 0x7B,
 0x87, 0xAB, 0x5B, 0x67, 0x97, 0x3B, 0x4B, 0x83,
 0x23, 0x2F, 0x73, 0x0F, 0x1B, 0x5F, 0x00, 0x0B,
 0xAB, 0x6F, 0x4F, 0xA3, 0x6B, 0x4F, 0x9B, 0x67,
 0x4F, 0x93, 0x5F, 0x4F, 0x8F, 0x5F, 0x4F, 0x87,
 0x5B, 0x4B, 0x7F, 0x57, 0x4B, 0x7B, 0x53, 0x4B,
 0xFF, 0xE3, 0xCF, 0xF7, 0xC3, 0x9B, 0xF3, 0xA3,
 0x6B, 0xEB, 0x87, 0x3F, 0xD3, 0x6F, 0x27, 0xBB,
 0x5B, 0x17, 0xA3, 0x47, 0x07, 0x8B, 0x37, 0x00,
 0xDB, 0xB7, 0xA3, 0xD3, 0xAB, 0x93, 0xCF, 0xA3,
 0x87, 0xCB, 0x97, 0x7B, 0xC3, 0x8F, 0x6F, 0xBF,
 0x87, 0x63, 0xBB, 0x7F, 0x57, 0xB7, 0x77, 0x4F,
 0xFF, 0xFB, 0xEB, 0xFB, 0xEB, 0xB7, 0xF7, 0xDF,
 0x87, 0xF3, 0xD7, 0x5B, 0xDB, 0xBB, 0x47, 0xC7,
 0x9F, 0x33, 0xAF, 0x87, 0x27, 0x9B, 0x6F, 0x1B,
 0xAF, 0x97, 0x4F, 0x9F, 0x8B, 0x3F, 0x93, 0x7F,
 0x33, 0x87, 0x73, 0x27, 0x77, 0x6B, 0x1B, 0x6B,
 0x5F, 0x13, 0x5F, 0x53, 0x0B, 0x53, 0x4B, 0x07,
 0xA3, 0xDF, 0x83, 0x8F, 0xCB, 0x6B, 0x7B, 0xB7,
 0x53, 0x6B, 0xA3, 0x3F, 0x5F, 0x8F, 0x2F, 0x4F,
 0x7B, 0x1F, 0x43, 0x67, 0x13, 0x37, 0x53, 0x0B,
 0x83, 0xC3, 0x73, 0x6F, 0xAF, 0x5B, 0x5F, 0x9B,
 0x43, 0x4F, 0x8B, 0x2F, 0x3F, 0x77, 0x1F, 0x33,
 0x63, 0x13, 0x2B, 0x53, 0x0B, 0x27, 0x47, 0x07,
 0xEB, 0xF3, 0xFF, 0xB7, 0xCB, 0xE7, 0x8F, 0xAB,
 0xCF, 0x67, 0x8B, 0xBB, 0x47, 0x6F, 0xA3, 0x2B,
 0x57, 0x8F, 0x17, 0x43, 0x77, 0x07, 0x33, 0x63,
 0xE7, 0xEB, 0xFF, 0xDB, 0xDF, 0xF7, 0xC7, 0xCB,
 0xE7, 0xB3, 0xBB, 0xDB, 0xA3, 0xAB, 0xCF, 0x8F,
 0x97, 0xBB, 0x7B, 0x83, 0xA7, 0x67, 0x73, 0x97,
 0xFB, 0xD3, 0xFF, 0xEB, 0xBB, 0xEB, 0xD7, 0xA3,
 0xCF, 0xC3, 0x8F, 0xB7, 0xB3, 0x7B, 0x9F, 0x9F,
 0x67, 0x87, 0x8B, 0x57, 0x6F, 0x7B, 0x47, 0x5B,
 0xEF, 0xE7, 0xF3, 0xE7, 0xDB, 0xEB, 0xCF, 0xBF,
 0xD7, 0xB7, 0xA3, 0xC3, 0xA3, 0x87, 0xAF, 0x8F,
 0x6F, 0x9B, 0x7B, 0x5B, 0x87, 0x67, 0x47, 0x73,
 0xEB, 0xEB, 0xFF, 0xCB, 0xC7, 0xEF, 0xAF, 0xAB,
 0xDF, 0x97, 0x8F, 0xCF, 0x87, 0x73, 0xBF, 0x73,
 0x5F, 0xAF, 0x67, 0x47, 0x9F, 0x5B, 0x37, 0x93,
 0xFF, 0xFF, 0xFF, 0xEB, 0xF3, 0xE7, 0xDB, 0xE7,
 0xD3, 0xCB, 0xDB, 0xBF, 0xBB, 0xCF, 0xAB, 0xAB,
 0xC3, 0x9B, 0x9B, 0xB7, 0x8B, 0x8F, 0xAF, 0x7B,
 0xFF, 0xAF, 0xC3, 0xEF, 0x7F, 0x9F, 0xE3, 0x4F,
 0x7F, 0xD3, 0x27, 0x67, 0xC7, 0x07, 0x53, 0xAB,
 0x07, 0x47, 0x8F, 0x0B, 0x3F, 0x6F, 0x07, 0x2F,
 0xFF, 0xFB, 0xAF, 0xF3, 0xEF, 0x9F, 0xE3, 0xE7,
 0x93, 0xD3, 0xDB, 0x87, 0xC7, 0xCF, 0x7F, 0xB7,
 0xC3, 0x73, 0xA7, 0xB7, 0x67, 0x9B, 0xAB, 0x5F,
 0xF7, 0xE7, 0xE7, 0xEB, 0xCF, 0xCF, 0xDB, 0xBB,
 0xBB, 0xCF, 0xA7, 0xA7, 0xC3, 0x97, 0x97, 0xB7,
 0x87, 0x87, 0xAB, 0x77, 0x77, 0x9F, 0x67, 0x67,
 0x93, 0x57, 0x57, 0x87, 0x4B, 0x4B, 0x7B, 0x3F,
 0x3F, 0x6F, 0x33, 0x33, 0x63, 0x2B, 0x2B, 0x57,
 0x1F, 0x1F, 0x4B, 0x17, 0x17, 0x3F, 0x13, 0x13,
 0xF3, 0xEF, 0xF7, 0xE3, 0xDB, 0xEB, 0xD3, 0xC7,
 0xDF, 0xC3, 0xB3, 0xD7, 0xB3, 0xA3, 0xCB, 0xA7,
 0x93, 0xC3, 0x97, 0x83, 0xB7, 0x87, 0x73, 0xAB,
 0x7B, 0x67, 0xA3, 0x6F, 0x5B, 0x97, 0x63, 0x4F,
 0x8F, 0x53, 0x43, 0x83, 0x47, 0x37, 0x77, 0x3F,
 0x2F, 0x6F, 0x33, 0x27, 0x63, 0x2B, 0x1F, 0x5B,
 0xFF, 0xFB, 0xDF, 0xEF, 0xEB, 0xCB, 0xE3, 0xDF,
 0xBB, 0xD7, 0xCF, 0xAB, 0xCB, 0xC3, 0x9B, 0xBF,
 0xB3, 0x8B, 0xB3, 0xA7, 0x7F, 0xA7, 0x9B, 0x73,
 0x9B, 0x8F, 0x63, 0x8B, 0x7F, 0x57, 0x7F, 0x73,
 0x4B, 0x73, 0x67, 0x43, 0x67, 0x5B, 0x37, 0x5B,
 0x4F, 0x2F, 0x4F, 0x43, 0x27, 0x43, 0x37, 0x1F,
 0xF7, 0xF7, 0xF7, 0xE7, 0xE3, 0xE3, 0xDB, 0xD3,
 0xD3, 0xCB, 0xC3, 0xC3, 0xBF, 0xB3, 0xB3, 0xAF,
 0xA7, 0xA7, 0xA3, 0x97, 0x97, 0x93, 0x87, 0x87,
 0x87, 0x7B, 0x7B, 0x77, 0x6B, 0x6B, 0x6B, 0x5F,
 0x5F, 0x5B, 0x4F, 0x4F, 0x4F, 0x43, 0x43, 0x3F,
 0x37, 0x37, 0x33, 0x2B, 0x2B, 0x17, 0x13, 0x13,
 0xFF, 0xFF, 0xFF, 0xF3, 0xEF, 0xEB, 0xE7, 0xDF,
 0xDB, 0xDB, 0xD3, 0xCF, 0xCF, 0xC3, 0xBF, 0xC3,
 0xB7, 0xB3, 0xB7, 0xAB, 0xA7, 0xAB, 0x9F, 0x9B,
 0x9F, 0x93, 0x8B, 0x93, 0x87, 0x7F, 0x87, 0x7B,
 0x73, 0x7B, 0x6F, 0x67, 0x73, 0x67, 0x5F, 0x67,
 0x5B, 0x53, 0x5B, 0x4F, 0x47, 0x53, 0x47, 0x3F,
 0xEB, 0xD7, 0xF3, 0xCF, 0xA7, 0xDF, 0xB7, 0x7F,
 0xCB, 0xA3, 0x5B, 0xB7, 0x93, 0x3F, 0xA7, 0x7F,
 0x23, 0x93, 0x6F, 0x0F, 0x7F, 0x5F, 0x00, 0x6F,
 0x8B, 0xBF, 0xF3, 0x77, 0x93, 0xF7, 0x67, 0x63,
 0xFF, 0x4B, 0x47, 0xE3, 0x2F, 0x2F, 0xC7, 0x1B,
 0x1B, 0xAF, 0x0B, 0x0B, 0x93, 0x00, 0x00, 0x7B,
 0xFF, 0x5F, 0x1B, 0xFF, 0xEF, 0x07, 0x97, 0xD7,
 0x0B, 0x00, 0x87, 0x47, 0x00, 0x87, 0x8B, 0x13,
 0x5F, 0xFF, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37,
 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7,
 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00,
 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x67, 0x53, 0x00};


static void fshDecompile(char *Output, char *Input) {
  char Tmp[1024];
  int I, J, K, C, W,H,X,Y;
  pic *P;
  int L = fileSize(Input);
  u1 *M = readFile(0, L, Input);
  u1 *Q = M;
  int NFrames = ru2(Q);
  u2 *S = (u2*)Q;
  Q = (u1*)(S + NFrames);

  times (I, NFrames) {
    W = *Q++;
    H = *Q++;
    X = *Q++;
    Y = *Q++;
    P = picNew(W,H,8);
    P->K = 0;
    times (K, 256) {
      P->P[K*4+0] = Pal[K*3+0];
      P->P[K*4+1] = Pal[K*3+1];
      P->P[K*4+2] = Pal[K*3+2];
      P->P[K*4+3] = 0;
    }
    times (Y,P->H) times (X, P->W) picPut(P,X,P->H-Y-1,*Q++);
    if (!P->W || !P->H) continue;
    sprintf(Tmp, "%s/%03d.png", Output, I);
    pngSave(Tmp, P);
  }
}

int fshInit(format *F) {
  F->Type = FMT_ARCHIVE;
  F->Name = "fsh";
  F->Description = "Furcadia Shape";
  F->Decompile = fshDecompile;
  return 1;
}


