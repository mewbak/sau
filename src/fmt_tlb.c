//Credits go to Dan Autery, author of TLBFORM.TXT
//              I take credit for decompression code

#include "common.h"

typedef struct {
  u1 Id[4]; // HLIB
  u4 Len;  // uncompressed size of whole archive
  u2 NFiles;
  u1 Enc;   // 0 - plain text
            // 1 - 
            // 2 - 
            // 3 -
            // 4 -
            // 5 - LZ
  u1 Flags; // 1 - ID table is present
  u1 Type[4]; //HLIB, TILE, TIL2, DIG4
} __attribute__ ((packed)) hlib;

typedef struct {
  u2 H;
  s2 X;
  s2 Y;
  u1 W; //divided by 4
  u1 Type; // 8  - Palette
           // 16 - plain
           // 17 - plain transparent with mask
           // 18 - RLE
           // 21 - plain transparent
           // 23 - RLE transparent
           // 24 - Palette
           // 25 - Image ID table
} __attribute__ ((packed)) frame;

typedef struct {
  u2 Cycling;
  u2 Start; // where to copy colors
  u2 NColors;
  u1 NRanges; // number of color cycling ranges
  u1 Flags;
} __attribute__ ((packed)) pal;

static u1 UAPal[] = {
 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF,
 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF,
 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF,
 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF,
 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF,
 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF,
 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF,
 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF,
 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xEF, 0x00, 0x00,
 0xE3, 0x00, 0x00, 0xD7, 0x00, 0x00, 0xCB, 0x00,
 0x00, 0xBF, 0x00, 0x00, 0xB3, 0x00, 0x00, 0xA7,
 0x00, 0x00, 0x9B, 0x00, 0x00, 0x8B, 0x00, 0x00,
 0x7F, 0x00, 0x00, 0x73, 0x00, 0x00, 0x67, 0x00,
 0x00, 0x5B, 0x00, 0x00, 0x4F, 0x00, 0x00, 0x43,
 0x00, 0x00, 0xFF, 0xDB, 0xDB, 0xFF, 0xBB, 0xBB,
 0xFF, 0x9F, 0x9F, 0xFF, 0x7F, 0x7F, 0xFF, 0x5F,
 0x5F, 0xFF, 0x43, 0x43, 0xFF, 0x23, 0x23, 0xFF,
 0x00, 0x00, 0xFF, 0xAB, 0x5F, 0xFF, 0x9B, 0x43,
 0xFF, 0x8B, 0x23, 0xFF, 0x7B, 0x00, 0xE7, 0x6F,
 0x00, 0xCF, 0x63, 0x00, 0xB7, 0x57, 0x00, 0x9F,
 0x4F, 0x00, 0xFF, 0xFF, 0xDB, 0xFF, 0xFF, 0xBB,
 0xFF, 0xFF, 0x9F, 0xFF, 0xFF, 0x7F, 0xFF, 0xFB,
 0x5F, 0xFF, 0xF7, 0x43, 0xFF, 0xF7, 0x23, 0xFF,
 0xF7, 0x00, 0xE7, 0xDB, 0x00, 0xCF, 0xC7, 0x00,
 0xB7, 0xAF, 0x00, 0x9F, 0x9F, 0x00, 0x87, 0x87,
 0x00, 0x73, 0x6F, 0x00, 0x5B, 0x57, 0x00, 0x43,
 0x43, 0x00, 0xD3, 0xFF, 0x5F, 0xC7, 0xFF, 0x43,
 0xB7, 0xFF, 0x23, 0xA3, 0xFF, 0x00, 0x93, 0xE7,
 0x00, 0x83, 0xCF, 0x00, 0x77, 0xB7, 0x00, 0x63,
 0x9F, 0x00, 0xDB, 0xFF, 0xDB, 0xBF, 0xFF, 0xBB,
 0x9F, 0xFF, 0x9F, 0x83, 0xFF, 0x7F, 0x63, 0xFF,
 0x5F, 0x43, 0xFF, 0x43, 0x23, 0xFF, 0x23, 0x00,
 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xEF, 0x00,
 0x00, 0xE3, 0x00, 0x00, 0xD7, 0x00, 0x07, 0xCB,
 0x00, 0x07, 0xBF, 0x00, 0x07, 0xB3, 0x00, 0x07,
 0xA7, 0x00, 0x07, 0x9B, 0x00, 0x07, 0x8B, 0x00,
 0x07, 0x7F, 0x00, 0x07, 0x73, 0x00, 0x07, 0x67,
 0x00, 0x07, 0x5B, 0x00, 0x07, 0x4F, 0x00, 0x07,
 0x43, 0x00, 0xDB, 0xFF, 0xFF, 0xBB, 0xFF, 0xFF,
 0x9F, 0xFF, 0xFF, 0x7F, 0xFF, 0xFB, 0x5F, 0xFF,
 0xFF, 0x43, 0xFF, 0xFF, 0x23, 0xFF, 0xFF, 0x00,
 0xFF, 0xFF, 0x00, 0xE7, 0xE7, 0x00, 0xCF, 0xCF,
 0x00, 0xB7, 0xB7, 0x00, 0x9F, 0x9F, 0x00, 0x87,
 0x87, 0x00, 0x73, 0x73, 0x00, 0x5B, 0x5B, 0x00,
 0x43, 0x43, 0x5F, 0xBF, 0xFF, 0x43, 0xB3, 0xFF,
 0x23, 0xAB, 0xFF, 0x00, 0x9F, 0xFF, 0x00, 0x8F,
 0xE7, 0x00, 0x7F, 0xCF, 0x00, 0x6F, 0xB7, 0x00,
 0x5F, 0x9F, 0xDB, 0xDB, 0xFF, 0xBB, 0xBF, 0xFF,
 0x9F, 0x9F, 0xFF, 0x7F, 0x83, 0xFF, 0x5F, 0x63,
 0xFF, 0x43, 0x43, 0xFF, 0x23, 0x27, 0xFF, 0x00,
 0x07, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xEF,
 0x00, 0x00, 0xE3, 0x00, 0x00, 0xD7, 0x00, 0x00,
 0xCB, 0x00, 0x00, 0xBF, 0x00, 0x00, 0xB3, 0x00,
 0x00, 0xA7, 0x00, 0x00, 0x9B, 0x00, 0x00, 0x8B,
 0x00, 0x00, 0x7F, 0x00, 0x00, 0x73, 0x00, 0x00,
 0x67, 0x00, 0x00, 0x5B, 0x00, 0x00, 0x4F, 0x00,
 0x00, 0x43, 0xF3, 0xDB, 0xFF, 0xE7, 0xBB, 0xFF,
 0xDB, 0x9F, 0xFF, 0xD3, 0x7F, 0xFF, 0xCB, 0x5F,
 0xFF, 0xBF, 0x43, 0xFF, 0xB7, 0x23, 0xFF, 0xAB,
 0x00, 0xFF, 0x9B, 0x00, 0xE7, 0x83, 0x00, 0xCF,
 0x77, 0x00, 0xB7, 0x63, 0x00, 0x9F, 0x53, 0x00,
 0x87, 0x47, 0x00, 0x73, 0x37, 0x00, 0x5B, 0x2B,
 0x00, 0x43, 0xFF, 0xDB, 0xFF, 0xFF, 0xBB, 0xFF,
 0xFF, 0x9F, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0x5F,
 0xFF, 0xFF, 0x43, 0xFF, 0xFF, 0x23, 0xFF, 0xFF,
 0x00, 0xFF, 0xE3, 0x00, 0xE7, 0xCB, 0x00, 0xCF,
 0xB7, 0x00, 0xB7, 0x9F, 0x00, 0x9F, 0x87, 0x00,
 0x87, 0x6F, 0x00, 0x73, 0x5B, 0x00, 0x5B, 0x43,
 0x00, 0x43, 0xFF, 0xEB, 0xDF, 0xFF, 0xE3, 0xD3,
 0xFF, 0xDB, 0xC7, 0xFF, 0xD7, 0xBF, 0xFF, 0xCF,
 0xB3, 0xFF, 0xC7, 0xA7, 0xFF, 0xBF, 0x9F, 0xFF,
 0xBB, 0x93, 0xFF, 0xB3, 0x83, 0xFF, 0xA7, 0x73,
 0xFF, 0x9F, 0x63, 0xF3, 0x97, 0x5F, 0xEB, 0x8F,
 0x5B, 0xDF, 0x8B, 0x57, 0xD3, 0x83, 0x53, 0xCB,
 0x7F, 0x4F, 0xBF, 0x7B, 0x4B, 0xB7, 0x73, 0x47,
 0xAB, 0x6B, 0x43, 0xA3, 0x67, 0x3F, 0x9F, 0x63,
 0x3B, 0x93, 0x5F, 0x37, 0x8B, 0x5B, 0x33, 0x83,
 0x53, 0x2F, 0x77, 0x4F, 0x2B, 0x6F, 0x4B, 0x27,
 0x5F, 0x43, 0x23, 0x57, 0x3F, 0x1F, 0x4B, 0x3B,
 0x1B, 0x43, 0x33, 0x1B, 0x3B, 0x2F, 0x17, 0x2B,
 0x23, 0x0F, 0xEF, 0xEF, 0xEF, 0xDF, 0xDF, 0xDF,
 0xD3, 0xD3, 0xD3, 0xC3, 0xC3, 0xC3, 0xB7, 0xB7,
 0xB7, 0xAB, 0xAB, 0xAB, 0x9B, 0x9B, 0x9B, 0x8F,
 0x8F, 0x8F, 0x7F, 0x7F, 0x7F, 0x73, 0x73, 0x73,
 0x67, 0x67, 0x67, 0x57, 0x57, 0x57, 0x4B, 0x4B,
 0x4B, 0x3B, 0x3B, 0x3B, 0x2F, 0x2F, 0x2F, 0x23,
 0x23, 0x23, 0x2B, 0xC7, 0x33, 0x2B, 0xC7, 0x5F,
 0x2B, 0xC7, 0x8B, 0x2B, 0xC7, 0xB7, 0x2B, 0xAB,
 0xC7, 0x2B, 0x7F, 0xC7, 0x2B, 0x53, 0xC7, 0x2F,
 0x2B, 0xC7, 0x5B, 0x2B, 0xC7, 0x87, 0x2B, 0xC7,
 0xB3, 0x2B, 0xC7, 0xC7, 0x2B, 0xAF, 0xC7, 0x2B,
 0x83, 0xC7, 0x2B, 0x57, 0xC7, 0x2B, 0x2B, 0xFF,
 0xFF, 0x9F};

//first 168 colors are static
static u1 AQPal[] = {
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x37, 0x07,
 0x00, 0x47, 0x0B, 0x00, 0x63, 0x0F, 0x00, 0x7B,
 0x17, 0x00, 0x97, 0x1F, 0x00, 0xAF, 0x27, 0x00,
 0xCB, 0x2B, 0x00, 0xE7, 0x37, 0x00, 0xFF, 0x43,
 0x00, 0xFF, 0x57, 0x27, 0xFF, 0x6F, 0x53, 0xFF,
 0x8B, 0x7F, 0xFF, 0xAF, 0xAB, 0xFF, 0xD7, 0xD7,
 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x1B, 0x1B,
 0x1B, 0x2B, 0x2B, 0x2B, 0x37, 0x3B, 0x3B, 0x47,
 0x47, 0x47, 0x53, 0x57, 0x57, 0x63, 0x67, 0x67,
 0x73, 0x77, 0x77, 0x83, 0x87, 0x87, 0x97, 0x9B,
 0x9B, 0xAB, 0xAF, 0xAF, 0xBF, 0xC3, 0xC3, 0xD3,
 0xD7, 0xD7, 0xE7, 0xEB, 0xEB, 0xFF, 0xFF, 0xFF,
 0x00, 0x00, 0x43, 0x00, 0x07, 0x53, 0x07, 0x0B,
 0x63, 0x0B, 0x13, 0x73, 0x13, 0x1F, 0x83, 0x1F,
 0x2F, 0x97, 0x2B, 0x3B, 0xA3, 0x33, 0x4B, 0xAB,
 0x3F, 0x5B, 0xB3, 0x4F, 0x6B, 0xBF, 0x5F, 0x7B,
 0xC7, 0x73, 0x8F, 0xD3, 0x87, 0xA3, 0xDF, 0x9B,
 0xB7, 0xE7, 0xB3, 0xC7, 0xF3, 0xCB, 0xDF, 0xFF,
 0x1F, 0x33, 0x00, 0x1F, 0x37, 0x00, 0x23, 0x3B,
 0x00, 0x2B, 0x47, 0x00, 0x33, 0x53, 0x00, 0x3B,
 0x5F, 0x07, 0x43, 0x6B, 0x07, 0x4F, 0x77, 0x07,
 0x5B, 0x87, 0x07, 0x67, 0x97, 0x0B, 0x73, 0xA3,
 0x0B, 0x83, 0xB3, 0x0F, 0x8F, 0xC3, 0x0F, 0x9F,
 0xD3, 0x13, 0xAF, 0xE7, 0x43, 0xCB, 0xFF, 0x7F,
 0x43, 0x27, 0x17, 0x4F, 0x2F, 0x1B, 0x5B, 0x33,
 0x1F, 0x67, 0x3B, 0x23, 0x73, 0x43, 0x27, 0x7F,
 0x47, 0x27, 0x8B, 0x4F, 0x2B, 0x9B, 0x5B, 0x2F,
 0xA3, 0x63, 0x37, 0xAB, 0x6B, 0x43, 0xB7, 0x77,
 0x4F, 0xC3, 0x7F, 0x5B, 0xCF, 0x8F, 0x67, 0xDB,
 0x9B, 0x77, 0xE7, 0xA7, 0x87, 0xF3, 0xB7, 0x97,
 0x2F, 0x17, 0x07, 0x3F, 0x1F, 0x07, 0x4F, 0x2B,
 0x07, 0x5F, 0x37, 0x07, 0x7B, 0x47, 0x07, 0x93,
 0x5B, 0x0B, 0xAF, 0x6F, 0x0B, 0xBB, 0x77, 0x0B,
 0xC7, 0x83, 0x0F, 0xD7, 0x8F, 0x13, 0xE3, 0x9B,
 0x1B, 0xF3, 0xAB, 0x2B, 0xFF, 0xBB, 0x3B, 0xFF,
 0xC7, 0x63, 0xFF, 0xD7, 0x77, 0xFF, 0xEF, 0xA3,
 0x33, 0x1B, 0x13, 0x37, 0x1F, 0x17, 0x3F, 0x23,
 0x17, 0x47, 0x27, 0x1B, 0x4B, 0x2B, 0x1F, 0x53,
 0x2F, 0x23, 0x5B, 0x33, 0x2B, 0x63, 0x3B, 0x2F,
 0x6F, 0x43, 0x37, 0x7B, 0x4B, 0x3B, 0x87, 0x57,
 0x43, 0x93, 0x5F, 0x4B, 0x9F, 0x6B, 0x53, 0xAB,
 0x77, 0x5B, 0xB7, 0x83, 0x63, 0xC3, 0x8F, 0x6B,
 0xCB, 0x97, 0x6F, 0xCF, 0x9B, 0x77, 0xD7, 0xA3,
 0x7B, 0xDB, 0xAF, 0x8F, 0xDF, 0xBF, 0x9F, 0xE7,
 0xCF, 0xB7, 0xEB, 0xDB, 0xCB, 0xF3, 0xEB, 0xE3,
 0x17, 0x3B, 0x4F, 0x1F, 0x53, 0x67, 0x2F, 0x6F,
 0x7F, 0x3B, 0x8B, 0x9B, 0x4B, 0xA7, 0xB3, 0x5B,
 0xC7, 0xCB, 0x6F, 0xE7, 0xE3, 0x7F, 0xFF, 0xF3,
 0x5B, 0x23, 0x07, 0x73, 0x2F, 0x07, 0x8B, 0x3B,
 0x07, 0xA3, 0x4B, 0x07, 0xB7, 0x57, 0x0B, 0xCF,
 0x63, 0x0B, 0xD3, 0x6B, 0x0B, 0xD3, 0x77, 0x0B,
 0xD7, 0x83, 0x0B, 0xDB, 0x97, 0x0B, 0xDF, 0xAB,
 0x0B, 0xE7, 0xBB, 0x0F, 0xEB, 0xCF, 0x1F, 0xF3,
 0xDF, 0x2F, 0xF7, 0xF3, 0x3F, 0xFB, 0xFF, 0x53,
 0x2F, 0x00, 0x47, 0x43, 0x07, 0x63, 0x5F, 0x1B,
 0x7F, 0x7B, 0x2F, 0x9F, 0x97, 0x4F, 0xBB, 0xB7,
 0x73, 0xDB, 0xCB, 0x93, 0xEB, 0xE7, 0xBB, 0xFF,
 0x2B, 0x00, 0x2F, 0x57, 0x07, 0x5F, 0x77, 0x0F,
 0x73, 0x9F, 0x23, 0x93, 0xCB, 0x3B, 0xAF, 0xDB,
 0x57, 0xCB, 0xEB, 0x77, 0xE7, 0xFB, 0x9F, 0xFF,
 0x1B, 0x3F, 0x2B, 0x27, 0x5B, 0x3F, 0x33, 0x77,
 0x53, 0x3F, 0x97, 0x67, 0x47, 0xBB, 0x7F, 0x5B,
 0xDB, 0x97, 0x73, 0xF7, 0xB7, 0x8F, 0xFF, 0xCF,
 0x1B, 0x1B, 0x1B, 0x23, 0x23, 0x23, 0x2B, 0x27,
 0x27, 0x33, 0x2F, 0x2F, 0x3B, 0x37, 0x37, 0x43,
 0x3F, 0x3F, 0x4B, 0x47, 0x47, 0x53, 0x4F, 0x4F,
 0x1B, 0x1B, 0x1B, 0x27, 0x23, 0x23, 0x33, 0x2F,
 0x2F, 0x3B, 0x37, 0x37, 0x43, 0x3F, 0x3F, 0x4B,
 0x47, 0x47, 0x53, 0x4F, 0x4F, 0x5F, 0x5B, 0x57,
 0x67, 0x63, 0x5F, 0x6F, 0x6B, 0x6B, 0x7B, 0x77,
 0x73, 0x87, 0x83, 0x7B, 0x97, 0x8F, 0x83, 0xA3,
 0x97, 0x8B, 0xB3, 0xA3, 0x93, 0xC3, 0xAF, 0x9B,
 0x23, 0x47, 0x37, 0x27, 0x4B, 0x33, 0x2F, 0x4F,
 0x33, 0x37, 0x53, 0x37, 0x43, 0x5B, 0x3F, 0x57,
 0x67, 0x4F, 0x6B, 0x77, 0x5F, 0x7F, 0x87, 0x73,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00,
 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF,
 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7,
 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00,
 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF,
 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7,
 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00,
 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF,
 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7,
 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00,
 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF,
 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7,
 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00,
 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF,
 0x00, 0xF7, 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0xF7,
 0xFF, 0x00, 0xF7, 0xFF, 0x00, 0x57, 0x5F, 0x77};


static u1 AQShip[] = {
 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xCB, 0x2B,
 0x00, 0xE7, 0x37, 0x00, 0xFF, 0x43, 0x00, 0xFF,
 0x57, 0x27, 0xFF, 0x6F, 0x53, 0xFF, 0x8B, 0x7F,
 0x1F, 0x33, 0x00, 0x1F, 0x37, 0x00, 0x23, 0x3B,
 0x00, 0x2B, 0x47, 0x00, 0x33, 0x53, 0x00, 0x3B,
 0x5F, 0x07, 0x43, 0x6B, 0x07, 0x4F, 0x77, 0x07,
 0x5B, 0x87, 0x07, 0x67, 0x97, 0x0B, 0x73, 0xA3,
 0x0B, 0x83, 0xB3, 0x0F, 0x8F, 0xC3, 0x0F, 0x9F,
 0xD3, 0x13, 0xAF, 0xE7, 0x43, 0xCB, 0xFF, 0x7F,
 0x43, 0x27, 0x17, 0x4F, 0x2F, 0x1B, 0x5B, 0x33,
 0x1F, 0x67, 0x3B, 0x23, 0x73, 0x43, 0x27, 0x7F,
 0x47, 0x27, 0x8B, 0x4F, 0x2B, 0x9B, 0x5B, 0x2F,
 0xA3, 0x63, 0x37, 0xAB, 0x6B, 0x43, 0xB7, 0x77,
 0x4F, 0xC3, 0x7F, 0x5B, 0xCF, 0x8F, 0x67, 0xDB,
 0x9B, 0x77, 0xE7, 0xA7, 0x87, 0xF3, 0xB7, 0x97,
 0x2F, 0x17, 0x07, 0x3F, 0x1F, 0x07, 0x4F, 0x2B,
 0x07, 0x5F, 0x37, 0x07, 0x7B, 0x47, 0x07, 0x93,
 0x5B, 0x0B, 0xAF, 0x6F, 0x0B, 0xBB, 0x77, 0x0B,
 0xC7, 0x83, 0x0F, 0xD7, 0x8F, 0x13, 0xE3, 0x9B,
 0x1B, 0xF3, 0xAB, 0x2B, 0xFF, 0xBB, 0x3B, 0xFF,
 0xC7, 0x63, 0xFF, 0xD7, 0x77, 0xFF, 0xEF, 0xA3,
 0x33, 0x1B, 0x13, 0x37, 0x1F, 0x17, 0x3F, 0x23,
 0x17, 0x47, 0x27, 0x1B, 0x4B, 0x2B, 0x1F, 0x53,
 0x2F, 0x23, 0x5B, 0x33, 0x2B, 0x63, 0x3B, 0x2F,
 0x6F, 0x43, 0x37, 0x7B, 0x4B, 0x3B, 0x87, 0x57,
 0x43, 0x93, 0x5F, 0x4B, 0x9F, 0x6B, 0x53, 0xAB,
 0x77, 0x5B, 0xB7, 0x83, 0x63, 0xC3, 0x8F, 0x6B,
 0xCB, 0x97, 0x6F, 0xCF, 0x9B, 0x77, 0xD7, 0xA3,
 0x7B, 0xDB, 0xAF, 0x8F, 0xDF, 0xBF, 0x9F, 0xE7,
 0xCF, 0xB7, 0x2B, 0x3B, 0xA3, 0x0B, 0x13, 0x73,
 0x00, 0x00, 0x00, 0x13, 0x13, 0x13, 0x2B, 0x2B,
 0x2B, 0x3F, 0x3F, 0x3F, 0x53, 0x53, 0x53, 0x6B,
 0x6B, 0x6B, 0x7F, 0x7F, 0x7F, 0x97, 0x97, 0x97,
 0x0F, 0x4F, 0x5B, 0x0F, 0x4F, 0x5B, 0x0F, 0x53,
 0x5B, 0x0F, 0x53, 0x5F, 0x0F, 0x57, 0x5F, 0x0F,
 0x5B, 0x5F, 0x13, 0x5B, 0x63, 0x13, 0x5F, 0x63,
 0x13, 0x5F, 0x63, 0x13, 0x63, 0x67, 0x13, 0x63,
 0x67, 0x13, 0x67, 0x67, 0x17, 0x6B, 0x6B, 0x17,
 0x6B, 0x6B, 0x17, 0x6B, 0x6B, 0x17, 0x6F, 0x6B,
 0x17, 0x6F, 0x6B, 0x17, 0x73, 0x6B, 0x1B, 0x73,
 0x6F, 0x1B, 0x73, 0x6F, 0x1B, 0x77, 0x73, 0x1F,
 0x77, 0x73, 0x1F, 0x7B, 0x77, 0x1F, 0x7B, 0x77,
 0x23, 0x7F, 0x77, 0x23, 0x7F, 0x7B, 0x27, 0x83,
 0x7B, 0x27, 0x83, 0x7F, 0x27, 0x83, 0x7F, 0x2B,
 0x87, 0x7F, 0x2B, 0x87, 0x83, 0x2F, 0x8B, 0x83,
 0x2F, 0x8B, 0x87, 0x2F, 0x8F, 0x87, 0x33, 0x8F,
 0x8B, 0x33, 0x93, 0x8B, 0x37, 0x93, 0x8B, 0x37,
 0x97, 0x8F, 0x3B, 0x97, 0x8F, 0x3B, 0x97, 0x93,
 0x3F, 0x9B, 0x93, 0x3F, 0x9B, 0x97, 0x43, 0x9F,
 0x97, 0x43, 0x9F, 0x97, 0x47, 0xA3, 0x9B, 0x47,
 0xA3, 0x9B, 0x4B, 0xA7, 0x9F, 0x4B, 0xA7, 0x9F,
 0x4F, 0xA7, 0xA3, 0x53, 0xAB, 0xA3, 0x53, 0xAB,
 0xA3, 0x57, 0xAF, 0xA7, 0x57, 0xAF, 0xA7, 0x5B,
 0xB3, 0xAB, 0x5B, 0xB3, 0xAB, 0x5F, 0xB3, 0xAB,
 0x5F, 0xB7, 0xAF, 0x63, 0xBB, 0xB3, 0x67, 0xBB,
 0xB3, 0x6B, 0xBF, 0xB7, 0x6F, 0xC3, 0xBB, 0x73,
 0xC7, 0xBF, 0x77, 0xC7, 0xBF, 0x7B, 0xCB, 0xC3,
 0x7F, 0xCF, 0xC7, 0x2F, 0x4B, 0x7F, 0x2F, 0x4B,
 0x7F, 0x2F, 0x4B, 0x83, 0x2F, 0x4F, 0x83, 0x2F,
 0x4F, 0x87, 0x33, 0x4F, 0x87, 0x33, 0x53, 0x8B,
 0x33, 0x53, 0x8B, 0x33, 0x53, 0x8F, 0x33, 0x57,
 0x93, 0x33, 0x57, 0x93, 0x33, 0x57, 0x97, 0x37,
 0x5B, 0x97, 0x37, 0x5B, 0x9B, 0x37, 0x5B, 0x9B,
 0x37, 0x5F, 0x9F, 0x37, 0x5F, 0x9F, 0x37, 0x5F,
 0xA3, 0x37, 0x63, 0xA3, 0x3B, 0x63, 0xA7, 0x3B,
 0x63, 0xA7, 0x3B, 0x67, 0xAB, 0x3B, 0x67, 0xAF,
 0x3B, 0x67, 0xAF, 0x3B, 0x6B, 0xB3, 0x3B, 0x6B,
 0xB3, 0x3F, 0x6B, 0xB7, 0x3F, 0x6F, 0xB7, 0x3F,
 0x6F, 0xBB, 0x3F, 0x73, 0xBB, 0x3F, 0x73, 0xBF,
 0x3F, 0x73, 0xBF, 0x3F, 0x77, 0xC3, 0x43, 0x77,
 0xC7, 0x43, 0x77, 0xC7, 0x43, 0x7B, 0xCB, 0x47,
 0x7B, 0xCB, 0x47, 0x7B, 0xCB, 0x47, 0x7B, 0xCF,
 0x47, 0x7F, 0xCF, 0x47, 0x7F, 0xCF, 0x4B, 0x83,
 0xD3, 0x4B, 0x83, 0xD3, 0x4B, 0x83, 0xD3, 0x4B,
 0x87, 0xD3, 0x4B, 0x87, 0xD7, 0x4F, 0x87, 0xD7,
 0x4F, 0x8B, 0xD7, 0x4F, 0x8B, 0xD7, 0x4F, 0x8B,
 0xDB, 0x4F, 0x8F, 0xDB, 0x53, 0x8F, 0xDB, 0x53,
 0x8F, 0xDB, 0x53, 0x93, 0xDF, 0x53, 0x93, 0xDF,
 0x53, 0x93, 0xDF, 0x57, 0x97, 0xDF, 0x57, 0x97,
 0xE3, 0x57, 0x97, 0xE3, 0x57, 0x9B, 0xE3, 0x57,
 0x9B, 0xE3, 0x5B, 0x9F, 0xDF, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00,
 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB,
 0x00, 0x00, 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x00,
 0xBB, 0x00, 0x00, 0xBB, 0x00, 0x57, 0x5F, 0x77};




#define LB(x) ((u1*)&(x))[0]
#define HB(x) ((u1*)&(x))[1]
#define LW(x) ((u2*)&(x))[0]

#define AL LB(A)
#define AH HB(A)
#define BL LB(B)
#define BH HB(B)
#define CL LB(C)
#define CH HB(C)
#define DL LB(D)
#define DH HB(D)

#define AX LW(A)
#define BX LW(B)
#define CX LW(C)
#define DX LW(D)

static u1 *decodeLZ(u1 *Dst, u1 *Src, int *OutLen) {
  u4 A=0, B=0, C=0, D=0;
  u1 *P, *O = Dst;

  for (AL = *Src++; AL != 0xFF; AL = *Src++) {
    if (!(AL&0x80)) {
      DL = AL;
      AH = *Src++;
      for (CL=(AH&0x18)>>3; CL; CL--) *Dst++ = *Src++;
      CL = (AH&7)+3; //backref len
      AL = AH;
      P = Dst - (((AX<<2)&0x380)|DL) - 1; //backref off
      for (; CL; CL--) *Dst++ = *P++;
    } else if (!(AL&0x40)) {
      DL = AL;
      AH = *Src++;
      DH = *Src++;
      for (CL=DH&3; CL; CL--) *Dst++ = *Src++;
      CL = (AH&0x1F)+3;
      DH = (DH>>1)&0x7E;
      DL &= 0x3F;
      AL = AH;
      P = Dst - (((AX<<1)&0x1C0)|DX) - 1;
      for (; CL; CL--) *Dst++ = *P++;
    } else if (!(AL&0x30)) {
      for (CL=((AL&0xF)+1)<<2; CL; CL--) *Dst++ = *Src++;
    } else {
      for (CL=AL&0xF; CL; CL--) *Dst++ = *Src++;
    }
  }
  *OutLen = Dst-O;

  return Src;
}

#define BLKSZ 8192


static int New;

static hlib *decode(hlib *H) {
  if (H->Len&1) H->Len++;
  unless (H->Enc) return H; //not compressed
  int Rest, C, OutLen;
  hlib *OH = (hlib*)ns(u1, H->Len*4 + BLKSZ); // should be enough
  memcpy(OH, H, 16);
  OH->Enc = 0;
  u1 *Dst = (u1*)(OH+1);
  u1 *Src = (u1*)(H+1)+2; //I've no idea, what the first two bytes mean
  for (Rest = H->Len-16; Rest > 0; Dst+=C, Rest-=C) {
    C = Rest < BLKSZ ? Rest : BLKSZ;
    if (H->Enc == 5) {
      Src = decodeLZ(Dst, Src, &OutLen);
    } else { //other four encodings were never used, but still supported by EXE
      printf("  unsupported encoding (%d)\n", H->Enc);
      abort();
    }
  }
  New = 1;
  return OH;
}

static void hlibUnpack(char *Output, hlib *H) {
  char Tmp[1024], Txt[1024], Name[128];
  int I, J, X, Y, Wide, High, S, C;
  frame *F;
  pic *P;
  u4 *O;
  u1 *Q, *M, *Z;
  pal *Pal = 0;

  unless (!strncmp(H->Id, "HLIB", 4)) {
    printf("  not a HLIB TLB file\n");
    abort();
  }

  H = decode(H);
  //writeFile(0, H->Len, "out/1.tlb", H);

  memcpy(Tmp, H->Type, 4);
  Tmp[4] = 0;

  O = (u4*)(H+1);

  if (H->Flags&1) {
    printf("  ID table is present\n");
    O++;
    H->NFiles--;
  }

  if (!strcmp(Tmp, "HLIB")) {
    printf("  going down\n");
    times (I, H->NFiles-1) {
      sprintf(Tmp, "%s/%04d", Output, I);
      hlibUnpack(Tmp, (hlib*)((u1*)H + O[I]));
    }
    printf("  going up\n");
  } else if (!strcmp(Tmp, "TILE")) {
    F = (frame*)((u1*)H + O[0]);
    if (F->Type == 8 || F->Type == 24) {
      printf("  palette is present\n");
      Pal = (pal*)F;
      O++;
    }

    times (I, H->NFiles-1) {
      F = (frame*)((u1*)H + O[I]);

      sprintf(Name, "%04d_%08X", I, O[I]);
      Wide = F->W*4;
      High = F->H;
      printf("  Extracting: %s\n", Name);
      printf("    %dx%d:%d,%d:%d\n", Wide, High, F->X, F->Y, F->Type);
      P = picNew(Wide, High, 8);
      times(Y,P->H) times(X,P->W*4) picPut(P,X,Y,0xFF);

      if (New) Q = AQPal;
      else Q = UAPal;

      //Q = AQShip;

      times (J, 256) {
        P->P[J*4+0] = Q[J*3+0];
        P->P[J*4+1] = Q[J*3+1];
        P->P[J*4+2] = Q[J*3+2];
      }

      if (Pal) {
        Q = (u1*)(Pal+1);
        times (J, Pal->NColors) {
          P->P[(J+Pal->Start)*4+0] = Q[J*3+0]<<2;
          P->P[(J+Pal->Start)*4+1] = Q[J*3+1]<<2;
          P->P[(J+Pal->Start)*4+2] = Q[J*3+2]<<2;
        }
      }

      Q = (u1*)(F+1);
      if (F->Type == 16) {
type16:
        // deinterlace
        S = F->W*4 * F->H;
        M = ns(u1, S);
        for (J = 0; J<S; J+=4) M[J] = *Q++;
        for (J = 1; J<S; J+=4) M[J] = *Q++;
        for (J = 2; J<S; J+=4) M[J] = *Q++;
        for (J = 3; J<S; J+=4) M[J] = *Q++;

        times(Y,F->H) times(X,F->W*4) picPut(P,X,Y,M[Y*F->W*4 + X]);
        free(M);
      } else if (F->Type == 17) {
        goto type16; // better than nothing
      } else if (F->Type == 18) {
        S = F->W*4 * F->H;
        M = Z = ns(u1, S*2);
        while (Z<M+S) {
          C = *Q++;
          if (C&0x80) {
            C=257-C;
            while (C--) *Z++ = *Q;
            Q++;
          } else {
            C += 1;
            while (C--) *Z++ = *Q++;
          }
        }
        times(Y,F->H) times(X,F->W*4) picPut(P,X,Y,M[Y*F->W*4 + X]);
      } else if (F->Type == 21) {
        P->K = 0xFF;
        goto type16;
      } else if (F->Type == 23) {
        P->K = 0xFF;
        times (J, 4) {
          for (Y=0; Y<F->H; Y++) {
            X = J;
            for (C=*Q++; C; C=*Q++) {
              if (C&0x80) X += (257-C)*4;
              else {
                for (; C--; X+=4) picPut(P,X,Y,*Q++);
              }
            }
          }
        }
      } else {
        printf("    unsupported frame type (%d)\n", F->Type);
        abort();
      }

      sprintf(Tmp, "%s/%s.txt", Output, Name);
      sprintf(Txt, "%d %d", F->X, F->Y);
      writeFile(0, strlen(Txt), Tmp, Txt);

      sprintf(Tmp, "%s/%s.png", Output, Name);
      pngSave(Tmp, P);
      picDel(P);
    }
  } else {
    printf("  unsupported TLB type: %s\n", Tmp);
    abort();
  }
}

static void tlbDecompile(char *Output, char *Input) {
  hlibUnpack(Output, readFile(0, fileSize(Input), Input));
}

int tlbInit(format *F) {
  F->Type = FMT_ARCHIVE;
  F->Name = "tlb";
  F->Description = "SSI Tileset (Al-Qadim, Entomorph, Unlimited Adventures, Gold Box games)";
  F->Decompile = tlbDecompile;
  return 1;
}

