//Credits go to SNV

#include "common.h"

static u1 DUNGEO01_PAL[] = {
 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x08, 0x06,
 0x0A, 0x0C, 0x0A, 0x10, 0x18, 0x10, 0x10, 0x18,
 0x12, 0x18, 0x22, 0x18, 0x20, 0x2B, 0x1E, 0x08,
 0x0C, 0x02, 0x0E, 0x14, 0x0E, 0x0A, 0x0E, 0x0A,
 0x10, 0x16, 0x10, 0x12, 0x1C, 0x12, 0x04, 0x06,
 0x04, 0x04, 0x06, 0x06, 0x04, 0x08, 0x04, 0x04,
 0x06, 0x00, 0x02, 0x06, 0x04, 0x08, 0x0E, 0x02,
 0x0E, 0x16, 0x0E, 0x04, 0x08, 0x00, 0x10, 0x1A,
 0x12, 0x0E, 0x16, 0x10, 0x0A, 0x10, 0x0C, 0x1A,
 0x25, 0x1A, 0x06, 0x0C, 0x08, 0x06, 0x0A, 0x06,
 0x04, 0x08, 0x08, 0x06, 0x0C, 0x04, 0x06, 0x0C,
 0x0A, 0x06, 0x0A, 0x00, 0x00, 0x02, 0x02, 0x06,
 0x08, 0x04, 0x0C, 0x14, 0x0C, 0x08, 0x0C, 0x08,
 0x06, 0x0A, 0x08, 0x0E, 0x18, 0x10, 0x0C, 0x16,
 0x0E, 0x08, 0x10, 0x02, 0x08, 0x0E, 0x0A, 0x0C,
 0x14, 0x0E, 0x14, 0x1E, 0x14, 0x08, 0x0C, 0x0A,
 0x04, 0x0A, 0x04, 0x0A, 0x12, 0x0A, 0x0C, 0x12,
 0x0C, 0x0C, 0x12, 0x06, 0x0C, 0x12, 0x0E, 0x08,
 0x0E, 0x08, 0x12, 0x18, 0x12, 0x06, 0x06, 0x06,
 0x08, 0x0E, 0x0C, 0x0A, 0x10, 0x0A, 0x0A, 0x10,
 0x04, 0x06, 0x0E, 0x08, 0x0A, 0x10, 0x0E, 0x0E,
 0x14, 0x10, 0x0A, 0x12, 0x0C, 0x08, 0x10, 0x0A,
 0x08, 0x08, 0x08, 0x14, 0x12, 0x14, 0x0C, 0x10,
 0x0C, 0x0C, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x25,
 0x31, 0x25, 0x3F, 0x3E, 0x2E, 0x36, 0x35, 0x29,
 0x2D, 0x2C, 0x24, 0x24, 0x24, 0x1E, 0x1B, 0x1B,
 0x18, 0x12, 0x12, 0x11, 0x09, 0x09, 0x09, 0x01,
 0x01, 0x01, 0x29, 0x30, 0x3F, 0x1E, 0x26, 0x37,
 0x15, 0x1D, 0x2F, 0x0E, 0x16, 0x28, 0x08, 0x0F,
 0x20, 0x04, 0x0A, 0x19, 0x01, 0x05, 0x11, 0x00,
 0x02, 0x0A, 0x3F, 0x0C, 0x0C, 0x38, 0x09, 0x09,
 0x31, 0x06, 0x06, 0x2A, 0x04, 0x04, 0x23, 0x02,
 0x02, 0x1C, 0x01, 0x01, 0x15, 0x00, 0x00, 0x0E,
 0x00, 0x00, 0x3F, 0x32, 0x27, 0x38, 0x2A, 0x21,
 0x32, 0x23, 0x1C, 0x2B, 0x1D, 0x18, 0x25, 0x17,
 0x13, 0x1E, 0x11, 0x0F, 0x18, 0x0C, 0x0B, 0x12,
 0x08, 0x08, 0x24, 0x31, 0x07, 0x1B, 0x2A, 0x05,
 0x13, 0x24, 0x03, 0x0C, 0x1D, 0x01, 0x07, 0x17,
 0x01, 0x03, 0x10, 0x00, 0x00, 0x0A, 0x00, 0x00,
 0x04, 0x00, 0x3F, 0x35, 0x21, 0x37, 0x2D, 0x18,
 0x2F, 0x26, 0x11, 0x27, 0x1F, 0x0B, 0x1F, 0x18,
 0x06, 0x17, 0x12, 0x02, 0x0F, 0x0C, 0x00, 0x08,
 0x06, 0x00, 0x39, 0x1E, 0x18, 0x31, 0x18, 0x11,
 0x29, 0x13, 0x0C, 0x22, 0x0F, 0x07, 0x1A, 0x0B,
 0x04, 0x13, 0x07, 0x01, 0x0B, 0x04, 0x00, 0x04,
 0x01, 0x00, 0x33, 0x32, 0x27, 0x30, 0x2F, 0x25,
 0x2A, 0x29, 0x22, 0x27, 0x26, 0x20, 0x21, 0x21,
 0x1C, 0x1E, 0x1E, 0x1A, 0x3F, 0x3F, 0x3F, 0x3F,
 0x3F, 0x3F, 0x02, 0x00, 0x00, 0x02, 0x02, 0x00,
 0x02, 0x02, 0x02, 0x04, 0x02, 0x00, 0x04, 0x02,
 0x02, 0x04, 0x04, 0x00, 0x04, 0x04, 0x02, 0x04,
 0x04, 0x04, 0x06, 0x04, 0x00, 0x06, 0x04, 0x02,
 0x06, 0x04, 0x04, 0x06, 0x06, 0x02, 0x06, 0x06,
 0x04, 0x08, 0x06, 0x02, 0x08, 0x06, 0x04, 0x08,
 0x06, 0x06, 0x08, 0x08, 0x04, 0x08, 0x08, 0x06,
 0x0A, 0x06, 0x02, 0x0A, 0x08, 0x02, 0x0A, 0x08,
 0x04, 0x0A, 0x08, 0x06, 0x0A, 0x0A, 0x04, 0x0A,
 0x0A, 0x06, 0x0A, 0x0A, 0x08, 0x0C, 0x08, 0x02,
 0x0C, 0x0A, 0x02, 0x0C, 0x0A, 0x04, 0x0C, 0x0A,
 0x06, 0x0C, 0x0A, 0x08, 0x0C, 0x0C, 0x06, 0x0C,
 0x0C, 0x08, 0x0E, 0x0A, 0x02, 0x0E, 0x0A, 0x06,
 0x0E, 0x0C, 0x04, 0x0E, 0x0C, 0x06, 0x0E, 0x0C,
 0x08, 0x0E, 0x0C, 0x0A, 0x0E, 0x0E, 0x08, 0x10,
 0x0A, 0x02, 0x10, 0x0C, 0x02, 0x10, 0x0C, 0x06,
 0x10, 0x0C, 0x08, 0x10, 0x0E, 0x04, 0x10, 0x0E,
 0x06, 0x10, 0x0E, 0x08, 0x10, 0x0E, 0x0A, 0x10,
 0x10, 0x08, 0x12, 0x0E, 0x04, 0x12, 0x0E, 0x06,
 0x12, 0x0E, 0x08, 0x12, 0x0E, 0x0A, 0x12, 0x10,
 0x06, 0x12, 0x10, 0x08, 0x12, 0x10, 0x0A, 0x12,
 0x10, 0x0C, 0x12, 0x12, 0x0C, 0x14, 0x0E, 0x04,
 0x14, 0x10, 0x04, 0x14, 0x10, 0x08, 0x14, 0x10,
 0x0A, 0x14, 0x10, 0x0C, 0x14, 0x12, 0x08, 0x14,
 0x12, 0x0A, 0x14, 0x12, 0x0C, 0x16, 0x10, 0x06,
 0x16, 0x12, 0x06, 0x16, 0x12, 0x08, 0x16, 0x12,
 0x0A, 0x16, 0x12, 0x0C, 0x16, 0x14, 0x08, 0x16,
 0x14, 0x0C, 0x18, 0x12, 0x06, 0x18, 0x12, 0x0A,
 0x18, 0x14, 0x06, 0x18, 0x14, 0x0A, 0x18, 0x14,
 0x0C, 0x18, 0x16, 0x0C, 0x1A, 0x14, 0x0A, 0x1A,
 0x16, 0x0A, 0x1A, 0x16, 0x0C, 0x1A, 0x16, 0x0E,
 0x1A, 0x18, 0x0E, 0x1C, 0x16, 0x08, 0x1C, 0x16,
 0x0A, 0x1C, 0x16, 0x0C, 0x1C, 0x18, 0x0A, 0x1C,
 0x18, 0x0E, 0x1C, 0x1A, 0x10, 0x1E, 0x16, 0x0A,
 0x1E, 0x18, 0x08, 0x1E, 0x18, 0x0C, 0x1E, 0x1A,
 0x0E, 0x1E, 0x1C, 0x10, 0x20, 0x18, 0x0C, 0x20,
 0x1A, 0x0C, 0x20, 0x1A, 0x0E, 0x22, 0x1C, 0x0C,
 0x22, 0x1C, 0x0E, 0x22, 0x1E, 0x12, 0x25, 0x1E,
 0x0C, 0x27, 0x1C, 0x0C, 0x27, 0x1E, 0x0C, 0x27,
 0x20, 0x14, 0x27, 0x25, 0x18, 0x29, 0x20, 0x0C,
 0x29, 0x20, 0x12, 0x2B, 0x20, 0x0E, 0x2B, 0x22,
 0x10, 0x2B, 0x25, 0x10, 0x2B, 0x25, 0x16, 0x2B,
 0x27, 0x18, 0x2D, 0x22, 0x0E, 0x2F, 0x25, 0x0E,
 0x2F, 0x27, 0x16, 0x31, 0x27, 0x10, 0x31, 0x27,
 0x14, 0x31, 0x2B, 0x1C, 0x31, 0x2D, 0x1C, 0x33,
 0x27, 0x12, 0x35, 0x2B, 0x12, 0x35, 0x2B, 0x14,
 0x35, 0x2B, 0x16, 0x35, 0x2B, 0x18, 0x35, 0x2D,
 0x16, 0x35, 0x2D, 0x1A, 0x35, 0x2F, 0x1E, 0x3F,
 0x3F, 0x3F};



typedef struct {
  u1 NFrames;
  u1 Unknown; // 0x80
  //frameHeader[NFrames];
} __attribute__ ((packed)) header;

typedef struct {
  u4 Off;
  u2 Len;
} __attribute__ ((packed)) frameHeader;

typedef struct {
  u2 T; // type or palette?
  u2 Width;
  u2 Height;
  u2 X; // X/Y is where monster's legs are located
  u2 Y;
  u2 R; // 320? related to screen dimension?
  u4 U; // zeroes
  u4 Size; // size of compressed image
  //Data[Size];
} __attribute__ ((packed)) frame;



// palette header
typedef struct {
  u2 Len;
  //u1 Colors[Len*3];
} __attribute__ ((packed)) palHeader;



static void decodeLZ77(u1 *D, u1 *S, int L) {
  u1 *P, *E = S+L;
  int C, B, R;

  while (S < E) {
    C = *S++;
    times (B, 8) {
      if (C&(1<<B)) { // backreference: 12-bit distance and 4-bit length
         R = *(u2*)S;
         S += 2;
         P = D-(R>>4);
         R = (R&0xF)+3;
         while(R--) *D++ = *P++;
      } else {
        *D++ = *S++;
      }
    }
  }
}

static void decodeRLE(u1 *D, u1 *S, int L) {
  while (L > 0) {
    int C = *S++;
    if (C&0x80) {
      C&=0x7f;
      while (C-- && L--) *D++ = 0;
    } else {
      while (C-- && L--) {
         *D++ = *S++&0x7F; // no idea why, but it overflows at 0x80
      }
    }
  }
}


static void loadPal(u1 *Out, char *Name) {
  int I;
  palHeader *PH = readFile(0, sizeof(palHeader), Name);
  u1 *Pal = readFile(sizeof(palHeader), PH->Len*3,  Name);

  times (I, PH->Len) { // as usual, VGA palette requires color-shift
    Out[I*4+0] = Pal[I*3+0]<<2;
    Out[I*4+1] = Pal[I*3+1]<<2;
    Out[I*4+2] = Pal[I*3+2]<<2;
    Out[I*4+3] = 0;
  }

  free(Pal);
}

spr *monLoad(char *Input) {
  char Tmp[1024], Dir[1024], Name[128], Ext[32];
  u1 *Buf;
  int I, J, X, Y, C;
  spr *S;
  pic *P;
  u1 *Pal;
  frame *F;
  int L = fileSize(Input);
  u1 *D = readFile(0, L, Input);
  header *H = (header*)D;
  frameHeader *FH = (frameHeader*)(D+sizeof(header));

  pathParts(Dir, Name, Ext, Input);
  downcase(Ext);

  S = sprNew();
  S->Palette = ns(u1, 4*256);

  sprintf(Tmp, "%s/%s.PAL", Dir, Name);

  unless (fileP(Tmp)) {
    printf("Missing '%s'\n", Tmp);
    abort();
  }

  Pal = DUNGEO01_PAL+2;


  times (I, 256) {
    S->Palette[I*4+0] = Pal[I*3+0]<<2;
    S->Palette[I*4+1] = Pal[I*3+1]<<2;
    S->Palette[I*4+2] = Pal[I*3+2]<<2;
    S->Palette[I*4+3] = 0;
  }

  loadPal(S->Palette, Tmp);

  S->NAnis = 1;
  S->Anis = ns(ani, S->NAnis);
  S->Anis[0].NFacs = 1;
  S->Anis[0].Facs = ns(fac,S->Anis[0].NFacs);
  S->Anis[0].Facs[0].NPics = H->NFrames;
  S->Anis[0].Facs[0].Pics = ns(pic*, S->Anis[0].Facs[0].NPics);

  times (I, H->NFrames) {
    if (!FH[I].Off) continue; // probably delay-frame
    F = (frame*)(D+FH[I].Off);
    //printf("%03d: Off=#%08x Len=#%04x\n", I, FH[I].Off, FH[I].Len);
    //printf(" T=%d %dx%d %d,%d R=%d U=%d S=%d\n"
    //      ,F->T, F->Width, F->Height, F->X, F->Y, F->R, F->U, F->Size);

    P = S->Anis[0].Facs[0].Pics[I] = picNew(F->Width, F->Height, 8);
    P->SharedPalette = 1;
    free(P->P);
    P->P = S->Palette;

    Buf = ns(u1, 2*F->Width*F->Height);
    decodeLZ77(Buf, (u1*)F+sizeof(frame), F->Size);
    decodeRLE(P->D, Buf, F->Width*F->Height);
    free(Buf);
  }
  return S;
}

int monInit(format *F) {
  F->Type = FMT_SPRITE;
  F->Name = "mon";
  F->Description = "Stonekeep sprites (MON, MSP, POJ, WPN, GXX)";
  // MMP and UBG are two other formats
  F->Load = monLoad;
  return 1;
}

