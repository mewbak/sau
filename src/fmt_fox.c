//Credits go to Dragon's Eye Productions, Inc.

#include "common.h"

static u1 Pal[] = {
 0x00, 0x00, 0x00, 0x00, 0xF7, 0x37, 0x00, 0xF7,
 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00,
 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37,
 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0xFF, 0x37,
 0x37, 0xE3, 0x27, 0x27, 0xC7, 0x17, 0x17, 0xAB,
 0x0B, 0x0B, 0x8F, 0x07, 0x07, 0x63, 0x00, 0x00,
 0xE7, 0xD3, 0xD7, 0xD3, 0xA3, 0xAF, 0xBF, 0x7B,
 0x87, 0xAB, 0x5B, 0x67, 0x97, 0x3B, 0x4B, 0x83,
 0x23, 0x2F, 0x73, 0x0F, 0x1B, 0x5F, 0x00, 0x0B,
 0xAB, 0x6F, 0x4F, 0xA3, 0x6B, 0x4F, 0x9B, 0x67,
 0x4F, 0x93, 0x5F, 0x4F, 0x8F, 0x5F, 0x4F, 0x87,
 0x5B, 0x4B, 0x7F, 0x57, 0x4B, 0x7B, 0x53, 0x4B,
 0xFF, 0xE3, 0xCF, 0xF7, 0xC3, 0x9B, 0xF3, 0xA3,
 0x6B, 0xEB, 0x87, 0x3F, 0xD3, 0x6F, 0x27, 0xBB,
 0x5B, 0x17, 0xA3, 0x47, 0x07, 0x8B, 0x37, 0x00,
 0xDB, 0xB7, 0xA3, 0xD3, 0xAB, 0x93, 0xCF, 0xA3,
 0x87, 0xCB, 0x97, 0x7B, 0xC3, 0x8F, 0x6F, 0xBF,
 0x87, 0x63, 0xBB, 0x7F, 0x57, 0xB7, 0x77, 0x4F,
 0xFF, 0xFB, 0xEB, 0xFB, 0xEB, 0xB7, 0xF7, 0xDF,
 0x87, 0xF3, 0xD7, 0x5B, 0xDB, 0xBB, 0x47, 0xC7,
 0x9F, 0x33, 0xAF, 0x87, 0x27, 0x9B, 0x6F, 0x1B,
 0xAF, 0x97, 0x4F, 0x9F, 0x8B, 0x3F, 0x93, 0x7F,
 0x33, 0x87, 0x73, 0x27, 0x77, 0x6B, 0x1B, 0x6B,
 0x5F, 0x13, 0x5F, 0x53, 0x0B, 0x53, 0x4B, 0x07,
 0xA3, 0xDF, 0x83, 0x8F, 0xCB, 0x6B, 0x7B, 0xB7,
 0x53, 0x6B, 0xA3, 0x3F, 0x5F, 0x8F, 0x2F, 0x4F,
 0x7B, 0x1F, 0x43, 0x67, 0x13, 0x37, 0x53, 0x0B,
 0x83, 0xC3, 0x73, 0x6F, 0xAF, 0x5B, 0x5F, 0x9B,
 0x43, 0x4F, 0x8B, 0x2F, 0x3F, 0x77, 0x1F, 0x33,
 0x63, 0x13, 0x2B, 0x53, 0x0B, 0x27, 0x47, 0x07,
 0xEB, 0xF3, 0xFF, 0xB7, 0xCB, 0xE7, 0x8F, 0xAB,
 0xCF, 0x67, 0x8B, 0xBB, 0x47, 0x6F, 0xA3, 0x2B,
 0x57, 0x8F, 0x17, 0x43, 0x77, 0x07, 0x33, 0x63,
 0xE7, 0xEB, 0xFF, 0xDB, 0xDF, 0xF7, 0xC7, 0xCB,
 0xE7, 0xB3, 0xBB, 0xDB, 0xA3, 0xAB, 0xCF, 0x8F,
 0x97, 0xBB, 0x7B, 0x83, 0xA7, 0x67, 0x73, 0x97,
 0xFB, 0xD3, 0xFF, 0xEB, 0xBB, 0xEB, 0xD7, 0xA3,
 0xCF, 0xC3, 0x8F, 0xB7, 0xB3, 0x7B, 0x9F, 0x9F,
 0x67, 0x87, 0x8B, 0x57, 0x6F, 0x7B, 0x47, 0x5B,
 0xEF, 0xE7, 0xF3, 0xE7, 0xDB, 0xEB, 0xCF, 0xBF,
 0xD7, 0xB7, 0xA3, 0xC3, 0xA3, 0x87, 0xAF, 0x8F,
 0x6F, 0x9B, 0x7B, 0x5B, 0x87, 0x67, 0x47, 0x73,
 0xEB, 0xEB, 0xFF, 0xCB, 0xC7, 0xEF, 0xAF, 0xAB,
 0xDF, 0x97, 0x8F, 0xCF, 0x87, 0x73, 0xBF, 0x73,
 0x5F, 0xAF, 0x67, 0x47, 0x9F, 0x5B, 0x37, 0x93,
 0xFF, 0xFF, 0xFF, 0xEB, 0xF3, 0xE7, 0xDB, 0xE7,
 0xD3, 0xCB, 0xDB, 0xBF, 0xBB, 0xCF, 0xAB, 0xAB,
 0xC3, 0x9B, 0x9B, 0xB7, 0x8B, 0x8F, 0xAF, 0x7B,
 0xFF, 0xAF, 0xC3, 0xEF, 0x7F, 0x9F, 0xE3, 0x4F,
 0x7F, 0xD3, 0x27, 0x67, 0xC7, 0x07, 0x53, 0xAB,
 0x07, 0x47, 0x8F, 0x0B, 0x3F, 0x6F, 0x07, 0x2F,
 0xFF, 0xFB, 0xAF, 0xF3, 0xEF, 0x9F, 0xE3, 0xE7,
 0x93, 0xD3, 0xDB, 0x87, 0xC7, 0xCF, 0x7F, 0xB7,
 0xC3, 0x73, 0xA7, 0xB7, 0x67, 0x9B, 0xAB, 0x5F,
 0xF7, 0xE7, 0xE7, 0xEB, 0xCF, 0xCF, 0xDB, 0xBB,
 0xBB, 0xCF, 0xA7, 0xA7, 0xC3, 0x97, 0x97, 0xB7,
 0x87, 0x87, 0xAB, 0x77, 0x77, 0x9F, 0x67, 0x67,
 0x93, 0x57, 0x57, 0x87, 0x4B, 0x4B, 0x7B, 0x3F,
 0x3F, 0x6F, 0x33, 0x33, 0x63, 0x2B, 0x2B, 0x57,
 0x1F, 0x1F, 0x4B, 0x17, 0x17, 0x3F, 0x13, 0x13,
 0xF3, 0xEF, 0xF7, 0xE3, 0xDB, 0xEB, 0xD3, 0xC7,
 0xDF, 0xC3, 0xB3, 0xD7, 0xB3, 0xA3, 0xCB, 0xA7,
 0x93, 0xC3, 0x97, 0x83, 0xB7, 0x87, 0x73, 0xAB,
 0x7B, 0x67, 0xA3, 0x6F, 0x5B, 0x97, 0x63, 0x4F,
 0x8F, 0x53, 0x43, 0x83, 0x47, 0x37, 0x77, 0x3F,
 0x2F, 0x6F, 0x33, 0x27, 0x63, 0x2B, 0x1F, 0x5B,
 0xFF, 0xFB, 0xDF, 0xEF, 0xEB, 0xCB, 0xE3, 0xDF,
 0xBB, 0xD7, 0xCF, 0xAB, 0xCB, 0xC3, 0x9B, 0xBF,
 0xB3, 0x8B, 0xB3, 0xA7, 0x7F, 0xA7, 0x9B, 0x73,
 0x9B, 0x8F, 0x63, 0x8B, 0x7F, 0x57, 0x7F, 0x73,
 0x4B, 0x73, 0x67, 0x43, 0x67, 0x5B, 0x37, 0x5B,
 0x4F, 0x2F, 0x4F, 0x43, 0x27, 0x43, 0x37, 0x1F,
 0xF7, 0xF7, 0xF7, 0xE7, 0xE3, 0xE3, 0xDB, 0xD3,
 0xD3, 0xCB, 0xC3, 0xC3, 0xBF, 0xB3, 0xB3, 0xAF,
 0xA7, 0xA7, 0xA3, 0x97, 0x97, 0x93, 0x87, 0x87,
 0x87, 0x7B, 0x7B, 0x77, 0x6B, 0x6B, 0x6B, 0x5F,
 0x5F, 0x5B, 0x4F, 0x4F, 0x4F, 0x43, 0x43, 0x3F,
 0x37, 0x37, 0x33, 0x2B, 0x2B, 0x17, 0x13, 0x13,
 0xFF, 0xFF, 0xFF, 0xF3, 0xEF, 0xEB, 0xE7, 0xDF,
 0xDB, 0xDB, 0xD3, 0xCF, 0xCF, 0xC3, 0xBF, 0xC3,
 0xB7, 0xB3, 0xB7, 0xAB, 0xA7, 0xAB, 0x9F, 0x9B,
 0x9F, 0x93, 0x8B, 0x93, 0x87, 0x7F, 0x87, 0x7B,
 0x73, 0x7B, 0x6F, 0x67, 0x73, 0x67, 0x5F, 0x67,
 0x5B, 0x53, 0x5B, 0x4F, 0x47, 0x53, 0x47, 0x3F,
 0xEB, 0xD7, 0xF3, 0xCF, 0xA7, 0xDF, 0xB7, 0x7F,
 0xCB, 0xA3, 0x5B, 0xB7, 0x93, 0x3F, 0xA7, 0x7F,
 0x23, 0x93, 0x6F, 0x0F, 0x7F, 0x5F, 0x00, 0x6F,
 0x8B, 0xBF, 0xF3, 0x77, 0x93, 0xF7, 0x67, 0x63,
 0xFF, 0x4B, 0x47, 0xE3, 0x2F, 0x2F, 0xC7, 0x1B,
 0x1B, 0xAF, 0x0B, 0x0B, 0x93, 0x00, 0x00, 0x7B,
 0xFF, 0x5F, 0x1B, 0xFF, 0xEF, 0x07, 0x97, 0xD7,
 0x0B, 0x00, 0x87, 0x47, 0x00, 0x87, 0x8B, 0x13,
 0x5F, 0xFF, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37,
 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7,
 0x37, 0x00, 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x00,
 0xF7, 0x37, 0x00, 0xF7, 0x37, 0x67, 0x53, 0x00};



typedef struct {
  u1 Magic[4]; // FSHX
  u4 Version; // FOX format version
  u4 NShapes;
  u4 Generator; //0=FSH Editor, 1=Dream Upload
  u4 Encryption; //0=unencrypted
  u1 Reserved[8];
} __attribute__ ((packed)) fox;

typedef struct {
  u2 Flags;
  s2 Override; //if not -1, index of the shape this shape replaces
  u2 NFrames;
  u2 NSteps;
} __attribute__ ((packed)) shape;

typedef struct { //only when fox.Version > 2
  u2 Len;
} __attribute__ ((packed)) shapeExt;

#define F_8BIT       1
#define F_BGR        2
#define F_BGRA       3
#define F_BGRA_RECOL 7

typedef struct {
  u2 F; //format
  u2 W;
  u2 H;
  s2 X; //shape X
  s2 Y; //shape Y
  s2 AX; //avatar X
  s2 AY; //avatar Y
  u4 Len;
  //frameExt Ext; //present only when fox.Version > 2
  //u1 Data[Len];
} __attribute__ ((packed)) frame;

typedef struct {
  u2 Len;
  u1 Opacity; //initial alpha level for the frame
  u1 Compression; //0=None, 1=PNG
} __attribute__ ((packed)) frameExt;

typedef struct {
  u2 Type;
  u2 Arg1; //value
  u2 Arg2; //counter_max
} __attribute__ ((packed)) step;


static void foxDecompile(char *Output, char *Input) {
  char Tmp[1024];
  int I, J, K, C, X,Y;
  pic *P;
  int L = fileSize(Input);
  u1 *M = readFile(0, L, Input);
  fox *FH = (fox*)M;
  shape *S = (shape*)(FH+1);
  step *St;
  shapeExt *SE;
  frame *F;
  frameExt *FE;
  u1 *Q,*Z;
  
  if (memcmp(FH->Magic, "FSHX", 4)) {
    printf("Not a Furcadia FOX file\n");
    abort();
  }

  if (FH->Encryption) {
    printf("Encrtypted FOX files are not supported\n");
    abort();
  }

  times (I, FH->NShapes) {
    SE = (shapeExt*)(S+1);
    if (FH->Version > 2) F = (frame*)((u1*)SE + SE->Len);
    else F = (frame*)SE;
    times (J, S->NFrames) {
      FE = (frameExt*)(F+1);
      if (FH->Version > 2) Q = (u1*)FE + FE->Len;
      else Q = (u1*)FE;
      Z = Q+F->Len;

      printf("%dx%d (%d)\n", F->W, F->H, F->F);

      if (FH->Version > 2 && FE->Compression) {
        printf("Compressed FOX files are not supported\n");
        abort();
      } else if (F->F == F_8BIT) {
        P = picNew(F->W, F->H, 8);
        P->K = 0;
        times (K, 256) {
          P->P[K*4+0] = Pal[K*3+0];
          P->P[K*4+1] = Pal[K*3+1];
          P->P[K*4+2] = Pal[K*3+2];
          P->P[K*4+3] = 0;
        }

        times (Y,P->H) times (X, P->W) picPut(P,X,P->H-Y-1,*Q++);
      } else {
        printf("Unsupported image format (%d)\n", F->F);
        abort();
      }
      sprintf(Tmp, "%s/%03d_%03d.png", Output, I, J);
      if (P->W && P->H) pngSave(Tmp, P);

      F = (frame*)Z;
    }
    St = (step*)Z;
    times (J, S->NSteps) {
      St++;
    }
    S = (shape*)St;
  }
}

int foxInit(format *F) {
  F->Type = FMT_ARCHIVE;
  F->Name = "fox";
  F->Description = "Furcadia Sprite";
  F->Decompile = foxDecompile;
  return 1;
}


